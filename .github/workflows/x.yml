name: x

on:
  schedule:
    - cron: "0 * * * *"  # every hour
  workflow_dispatch:

jobs:
  fetch-and-send:
    runs-on: ubuntu-latest
    env:
      WEBHOOK_X: ${{ secrets.X }}
      PAT: ${{ secrets.PAT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl python3-pip
          pip3 install pytz requests

      - name: Fetch tweets
        run: |
          curl -s 'https://www.archivlyx.com/api/x/user-tweets?username=pradabagshawty5&cursor=' \
            -H 'Accept: */*' \
            -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/26.0 Safari/605.1.15' \
            -o response.json

      - name: Process and post tweets with media
        run: |
          python3 - <<'EOF'
          import os, json, datetime, requests, pytz, re

          WEBHOOK = os.environ["WEBHOOK_X"]
          PAT_FILE = "last_posted_x.json"
          EASTERN = pytz.timezone("US/Eastern")

          # Load last posted tweet ID
          last_posted_id = None
          if os.path.exists(PAT_FILE):
              try:
                  data = json.load(open(PAT_FILE))
                  if isinstance(data, dict) and "last_id" in data:
                      last_posted_id = data["last_id"]
              except Exception:
                  last_posted_id = None

          with open("response.json") as f:
              tweets = json.load(f)["data"]["tweets"]

          # Filter new tweets
          new_tweets = [t for t in tweets if last_posted_id is None or t["id"] > last_posted_id]

          if new_tweets:
              latest_id = new_tweets[0]["id"]
              with open(PAT_FILE, "w") as f:
                  json.dump({"last_id": latest_id}, f)

              for tweet in reversed(new_tweets):  # oldest first
                  text = re.sub(r'https://t\.co/\S+', '', tweet["text"]).strip()

                  dt_utc = datetime.datetime.strptime(tweet["createdAt"], "%a %b %d %H:%M:%S %z %Y")
                  dt_est = dt_utc.astimezone(EASTERN)
                  formatted_time = dt_est.strftime("%-I:%M%p").lower()
                  formatted_date = dt_est.strftime("%m/%d/%y")

                  # Download media
                  files_to_send = []
                  for idx, media in enumerate(tweet.get("media", []), start=1):
                      url = media.get("videoUrl") or media.get("url")
                      if not url:
                          continue
                      ext = url.split('.')[-1].split('?')[0]
                      filename = f"{tweet['id']}-{idx}.{ext}"
                      r = requests.get(url, stream=True)
                      with open(filename, "wb") as f:
                          for chunk in r.iter_content(chunk_size=8192):
                              f.write(chunk)
                      files_to_send.append((filename, url))

                  # Build embed
                  embed = {
                      "title": text,
                      "description": f"{formatted_time}\n{formatted_date}",
                      "color": 0xFFFFFD,
                      "footer": {
                          "text": "@pradabagshawty5",
                          "icon_url": "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/X_logo.jpg/1024px-X_logo.jpg"
                      }
                  }

                  # Prepare payload
                  payload = {"content": "<@&1442336357312630895>", "embeds": [embed]}
                  files_payload = {f"file{i}": open(f, "rb") for i, (f, _) in enumerate(files_to_send, start=1)}

                  # Send main message
                  try:
                      requests.post(WEBHOOK, data={"payload_json": json.dumps(payload)}, files=files_payload)
                  except Exception:
                      # If attachment fails, post each media link separately
                      for _, link in files_to_send:
                          payload_link = {"content": f"-# [file exceeded limit]({link})", "embeds": []}
                          requests.post(WEBHOOK, json=payload_link)
                  finally:
                      for f, _ in files_to_send:
                          os.remove(f)
          EOF

      - name: Commit updated last_posted_x.json
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add last_posted_x.json
          git commit -m "Update last_posted_x.json" || echo "No changes to commit"
          git push https://x-access-token:${PAT}@github.com/${{ github.repository }} HEAD:main
