name: x

on:
  schedule:
    - cron: "0 * * * *"  # every hour
  workflow_dispatch:

jobs:
  fetch-and-send:
    runs-on: ubuntu-latest
    env:
      WEBHOOK_X: ${{ secrets.X }}
      PAT: ${{ secrets.PAT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl python3-pip
          pip3 install pytz requests

      - name: Fetch tweets
        run: |
          curl -s 'https://www.archivlyx.com/api/x/user-tweets?username=pradabagshawty5&cursor=' \
            -H 'Accept: */*' \
            -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/26.0 Safari/605.1.15' \
            -o response.json

      - name: Process and post tweets
        run: |
          python3 - <<'EOF'
          import os, json, datetime, requests, pytz, re

          WEBHOOK = os.environ["WEBHOOK_X"]
          PAT_FILE = "last_posted_x.json"
          EASTERN = pytz.timezone("US/Eastern")

          # Load last posted tweet ID
          last_posted_id = None
          if os.path.exists(PAT_FILE):
              try:
                  data = json.load(open(PAT_FILE))
                  if isinstance(data, dict) and "last_id" in data:
                      last_posted_id = data["last_id"]
              except Exception:
                  last_posted_id = None

          with open("response.json") as f:
              tweets = json.load(f)["data"]["tweets"]

          # Filter new tweets
          new_tweets = []
          for t in tweets:
              if last_posted_id is None or t["id"] > last_posted_id:
                  new_tweets.append(t)

          if new_tweets:
              # Update last posted ID
              latest_id = new_tweets[0]["id"]
              with open(PAT_FILE, "w") as f:
                  json.dump({"last_id": latest_id}, f)

              for tweet in reversed(new_tweets):  # oldest first
                  text = tweet["text"]
                  text = re.sub(r'https://t\.co/\S+', '', text).strip()

                  created_utc = tweet["createdAt"]
                  dt_utc = datetime.datetime.strptime(created_utc, "%a %b %d %H:%M:%S %z %Y")
                  dt_est = dt_utc.astimezone(EASTERN)

                  # Format time and date
                  formatted_time = dt_est.strftime("%-I:%M%p").lower()  # no space
                  formatted_date = dt_est.strftime("%m/%d/%y")

                  # Send main tweet message with text as title
                  embed_tweet = {
                      "title": text,
                      "description": f"{formatted_time}\n{formatted_date}",
                      "color": 0xFFFFFD,
                      "footer": {
                          "text": "@pradabagshawty5",
                          "icon_url": "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/X_logo.jpg/1024px-X_logo.jpg"
                      }
                  }

                  payload_tweet = {
                      "content": "<@&1442336357312630895>",
                      "embeds": [embed_tweet]
                  }

                  requests.post(WEBHOOK, json=payload_tweet)

                  # Send media URLs in separate message if any
                  media_links = tweet.get("media", [])
                  if media_links:
                      links_line = "".join(f"[<:blank:1442341014307082320>]({m.get('videoUrl') or m.get('url')})" for m in media_links)
                      payload_media = {
                          "content": links_line,
                          "embeds": []
                      }
                      requests.post(WEBHOOK, json=payload_media)
          EOF

      - name: Commit updated last_posted_x.json
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add last_posted_x.json
          git commit -m "Update last_posted_x.json" || echo "No changes to commit"
          git push https://x-access-token:${PAT}@github.com/${{ github.repository }} HEAD:main
